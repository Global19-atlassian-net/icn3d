iCn3DUI.prototype.DensityCifParser=function(t,e,n,r){var a,o=this,i=o.isMobile()||o.cfg.notebook?0:4;if("2fofc"==e||"fofc"==e?a="https://www.ebi.ac.uk/pdbe/densities/x-ray/"+t.toLowerCase()+"/cell?detail="+i:"em"==e&&(a="https://www.ebi.ac.uk/pdbe/densities/emd/"+r.toLowerCase()+"/cell?detail="+i),"2fofc"==e&&o.bAjax2fofc)o.icn3d.mapData.sigma2=n,o.setOption("map",e);else if("fofc"==e&&o.bAjaxfofc)o.icn3d.mapData.sigma=n,o.setOption("map",e);else if("em"==e&&o.bAjaxEm)o.icn3d.mapData.sigmaEm=n,o.setOption("emmap",e);else{var s=new XMLHttpRequest;s.open("GET",a,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){if(4==this.readyState){if(200==this.status){var t=s.response;o.parseChannels(t,e,n),"2fofc"==e||"fofc"==e?(o.bAjax2fofc=!0,o.bAjaxfofc=!0,o.setOption("map",e)):"em"==e&&(o.bAjaxEm=!0,o.setOption("emmap",e))}else"2fofc"==e||"fofc"==e?alert("Density server at EBI has no corresponding electron density map for this structure."):"em"==e&&alert("Density server at EBI has no corresponding EM density map for this structure.");void 0!==o.deferredEmmap&&o.deferredEmmap.resolve()}else o.showLoading()},s.send()}},iCn3DUI.prototype.parseChannels=function(t,e,n){var r=this,a=r.BinaryParse(t);if("2fofc"==e||"fofc"==e){var o=r.getChannel(a,"2FO-FC"),i=r.getChannel(a,"FO-FC"),s={xExtent:(d=(m=o).box.sampleCount)[0],yExtent:d[1],zExtent:d[2],mean:m.valuesInfo.mean,sigma:m.valuesInfo.sigma};r.icn3d.mapData.header2=s,r.icn3d.mapData.data2=m.data;var u=m.box.origin,f=m.box.dimensions,c=m.spacegroup.basis,l=(new THREE.Matrix4).makeScale(f[0]/d[0],f[1]/d[1],f[2]/d[2]),p=(new THREE.Matrix4).makeTranslation(u[0],u[1],u[2]),g=(new THREE.Matrix4).set(c.x[0],c.y[0],c.z[0],0,0,c.y[1],c.z[1],0,0,0,c.z[2],0,0,0,0,1).multiply(p).multiply(l);r.icn3d.mapData.matrix2=g,r.icn3d.mapData.type2=e,r.icn3d.mapData.sigma2=n;s={xExtent:(d=(m=i).box.sampleCount)[0],yExtent:d[1],zExtent:d[2],mean:m.valuesInfo.mean,sigma:m.valuesInfo.sigma};r.icn3d.mapData.header=s,r.icn3d.mapData.data=m.data;u=m.box.origin,f=m.box.dimensions,c=m.spacegroup.basis,l=(new THREE.Matrix4).makeScale(f[0]/d[0],f[1]/d[1],f[2]/d[2]),p=(new THREE.Matrix4).makeTranslation(u[0],u[1],u[2]),g=(new THREE.Matrix4).set(c.x[0],c.y[0],c.z[0],0,0,c.y[1],c.z[1],0,0,0,c.z[2],0,0,0,0,1).multiply(p).multiply(l);r.icn3d.mapData.matrix=g,r.icn3d.mapData.type=e,r.icn3d.mapData.sigma=n}else if("em"==e){var m,d;s={xExtent:(d=(m=r.getChannel(a,"EM")).box.sampleCount)[0],yExtent:d[1],zExtent:d[2],max:m.valuesInfo.max,min:m.valuesInfo.min};r.icn3d.mapData.headerEm=s,r.icn3d.mapData.dataEm=m.data;u=m.box.origin,f=m.box.dimensions,c=m.spacegroup.basis,l=(new THREE.Matrix4).makeScale(f[0]/d[0],f[1]/d[1],f[2]/d[2]),p=(new THREE.Matrix4).makeTranslation(u[0],u[1],u[2]),g=(new THREE.Matrix4).set(c.x[0],c.y[0],c.z[0],0,0,c.y[1],c.z[1],0,0,0,c.z[2],0,0,0,0,1).multiply(p).multiply(l);r.icn3d.mapData.matrixEm=g,r.icn3d.mapData.typeEm=e,r.icn3d.mapData.sigmaEm=n}},iCn3DUI.prototype.getChannel=function(t,e){for(var n,r=t.toJSON(),a=0,o=r.length;a<o;++a)r[a].id==e&&(n=t.dataBlocks[a]);return this.CIFParse(n)},iCn3DUI.prototype.CIFParse=function(t){var r=t.getCategory("_volume_data_3d_info");if(r){if(t.getCategory("_volume_data_3d")){var e={name:r.getColumn("name").getString(0),axisOrder:v("axis_order"),origin:v("origin"),dimensions:v("dimensions"),sampleCount:v("sample_count"),spacegroupNumber:0|w("spacegroup_number"),cellSize:v("spacegroup_cell_size"),cellAngles:v("spacegroup_cell_angles"),mean:w("mean_sampled"),sigma:w("sigma_sampled")},n=[0,0,0];n[e.axisOrder[0]]=0,n[e.axisOrder[1]]=1,n[e.axisOrder[2]]=2;var a,o,i,s,u,f,c,l,p,g,m,d,h=E(e.sampleCount),y=function(t,e,n,r){for(var a=new Float32Array(e[0]*e[1]*e[2]),o=[0,0,0],i=r[0],s=r[1],u=r[2],f=n[0],c=n[1],l=n[2],p=(e[0],e[0],e[1],e[2]),g=e[1]*e[2],m=0,d=t.getFloat(0),h=d,y=0;y<l;y++){o[2]=y;for(var v=0;v<c;v++){o[1]=v;for(var w=0;w<f;w++){o[0]=w;var E=t.getFloat(m);m+=1,(a[o[u]+o[s]*p+o[i]*g]=E)<d?d=E:h<E&&(h=E)}}}return{data:a,min:d,max:h}}(t.getCategory("_volume_data_3d").getColumn("values"),h,e.sampleCount,n);return{name:e.name,spacegroup:(a=e.spacegroupNumber,o=e.cellSize,i=e.cellAngles,s=Math.PI/180*i[0],u=Math.PI/180*i[1],f=Math.PI/180*i[2],c=o[0],l=o[1],p=o[2],g=Math.cos(u),m=(Math.cos(s)-Math.cos(u)*Math.cos(f))/Math.sin(f),d=Math.sqrt(1-g*g-m*m),{number:a,size:o,angles:i,basis:{x:[c,0,0],y:[Math.cos(f)*l,Math.sin(f)*l,0],z:[g*p,m*p,d*p]}}),box:{origin:E(e.origin),dimensions:E(e.dimensions),sampleCount:h},data:y.data,valuesInfo:{min:y.min,max:y.max,mean:e.mean,sigma:e.sigma}}}conole.log("_volume_data_3d category is missing.")}else conole.log("_volume_data_3d_info category is missing.");function v(t){for(var e=[0,0,0],n=0;n<3;n++)e[n]=r.getColumn(t+"["+n+"]").getFloat(0);return e}function w(t){return r.getColumn(t).getFloat(0)}function E(t){return[t[n[0]],t[n[1]],t[n[2]]]}},iCn3DUI.prototype.BinaryParse=function(t){var e=new Uint8Array(t),n=this.MessagePackParse({buffer:e,offset:0,dataView:new DataView(e.buffer)}),r=(Object.defineProperty(a.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),a.prototype.getCategory=function(t){return this.categoryMap.get(t)},a.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map(function(t){return t.toJSON()}),additionalData:this.additionalData}},a);function a(t){this.additionalData={},this.header=t.header,this.categoryList=t.categories.map(function(t){return new o(t)}),this.categoryMap=new Map;for(var e=0,n=this.categoryList;e<n.length;e++){var r=n[e];this.categoryMap.set(r.name,r)}}var o=function(){function t(t){this.name=t.name,this.columnCount=t.columns.length,this.rowCount=t.rowCount,this.columnNameList=[],this.encodedColumns=new Map;for(var e=0,n=t.columns;e<n.length;e++){var r=n[e];this.encodedColumns.set(r.name,r),this.columnNameList.push(r.name)}}Object.defineProperty(t.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0});var n=(e.prototype.getString=function(t){return null},e.prototype.getInteger=function(t){return 0},e.prototype.getFloat=function(t){return 0},e.prototype.getValuePresence=function(t){return 1},e.prototype.areValuesEqual=function(t,e){return!0},e.prototype.stringEquals=function(t,e){return null===e},e);function e(){this.isDefined=!1}return t.prototype.getColumn=function(t){var e=this.encodedColumns.get(t);return e?function(t){if(!t.data.data)return _UndefinedColumn;var e=d(t.data),n=void 0;t.mask&&(n=d(t.mask));if(e.buffer&&e.byteLength&&e.BYTES_PER_ELEMENT)return n?new E(e,n):new v(e);return n?new A(e,n):new C(e)}(e):n},t.prototype.toJSON=function(){for(var e=this,t=[],n=this.columnNameList.map(function(t){return{name:t,column:e.getColumn(t)}}),r=0;r<this.rowCount;r++){for(var a={},o=0,i=n;o<i.length;o++){var s=i[o],u=s.column.getValuePresence(r);a[s.name]=0===u?s.column.getString(r):1===u?".":"?"}t[r]=a}return{name:this.name,columns:this.columnNames,rows:t}},t}();function f(t,e){switch(t){case 1:return new Int8Array(e);case 2:return new Int16Array(e);case 3:return new Int32Array(e);case 4:return new Uint8Array(e);case 5:return new Uint16Array(e);case 6:return new Uint32Array(e);default:throw new Error("Unsupported integer data type.")}}function s(t,e){switch(t){case 32:return new Float32Array(e);case 33:return new Float64Array(e);default:throw new Error("Unsupported floating data type.")}}var i,u,c,l=(i=new ArrayBuffer(2),u=new Uint8Array(i),c=new Uint16Array(i),u[0]=170,u[1]=187,48042===c[0]);function p(t,e,n){return new n(l?t.buffer:function(t,e){for(var n=new ArrayBuffer(t.length),r=new Uint8Array(n),a=0,o=t.length;a<o;a+=e)for(var i=0;i<e;i++)r[a+e-i-1]=t[a+i];return n}(t,e))}function g(t,e){return e.isUnsigned?function(t,e){for(var n=1===e.byteCount?255:65535,r=t.length,a=new Int32Array(e.srcSize),o=0,i=0;o<r;){for(var s=0,u=t[o];u===n;)s+=u,u=t[++o];s+=u,a[i]=s,o++,i++}return a}(t,e):function(t,e){for(var n=1===e.byteCount?127:32767,r=-n-1,a=t.length,o=new Int32Array(e.srcSize),i=0,s=0;i<a;){for(var u=0,f=t[i];f===n||f===r;)u+=f,f=t[++i];u+=f,o[s]=u,i++,s++}return o}(t,e)}function m(t,e){switch(e.kind){case"ByteArray":switch(e.type){case 4:return t;case 1:return function(t){return new Int8Array(t.buffer,t.byteOffset)}(t);case 2:return function(t){return p(t,2,Int16Array)}(t);case 5:return function(t){return p(t,2,Uint16Array)}(t);case 3:return function(t){return p(t,4,Int32Array)}(t);case 6:return function(t){return p(t,4,Uint32Array)}(t);case 32:return function(t){return p(t,4,Float32Array)}(t);case 33:return function(t){return p(t,8,Float64Array)}(t);default:throw new Error("Unsupported ByteArray type.")}case"FixedPoint":return function(t,e){for(var n=t.length,r=s(e.srcType,n),a=1/e.factor,o=0;o<n;o++)r[o]=a*t[o];return r}(t,e);case"IntervalQuantization":return function(t,e){for(var n=t.length,r=s(e.srcType,n),a=(e.max-e.min)/(e.numSteps-1),o=e.min,i=0;i<n;i++)r[i]=o+a*t[i];return r}(t,e);case"RunLength":return function(t,e){for(var n=f(e.srcType,e.srcSize),r=0,a=0,o=t.length;a<o;a+=2)for(var i=t[a],s=t[a+1],u=0;u<s;++u)n[r++]=i;return n}(t,e);case"Delta":return function(t,e){var n=t.length,r=f(e.srcType,n);if(!n)return r;r[0]=t[0]+(0|e.origin);for(var a=1;a<n;++a)r[a]=t[a]+r[a-1];return r}(t,e);case"IntegerPacking":return g(t,e);case"StringArray":return function(t,e){for(var n=e.stringData,r=d({encoding:e.offsetEncoding,data:e.offsets}),a=d({encoding:e.dataEncoding,data:t}),o=Object.create(null),i=new Array(a.length),s=0,u=0,f=a;u<f.length;u++){var c=f[u];if(c<0)i[s++]=null;else{var l=o[c];void 0===l&&(l=n.substring(r[c],r[c+1]),o[c]=l),i[s++]=l}}return i}(t,e)}}function d(t){for(var e=t.data,n=t.encoding.length-1;0<=n;n--)e=m(e,t.encoding[n]);return e}function h(t,e,n){var r=0,a=1;for(45===t.charCodeAt(e)&&(a=-1,e++);e<n;e++){var o=t.charCodeAt(e)-48;if(9<o||o<0)return a*r|0;r=10*r+o|0}return a*r}function y(t,e,n){var r=1,a=0,o=0,i=1;for(45===t.charCodeAt(e)&&(r=-1,++e);e<n;){var s=t.charCodeAt(e)-48;if(!(0<=s&&s<10)){if(-2===s){for(++e;e<n;){if(!(0<=(s=t.charCodeAt(e)-48)&&s<10))return 53===s||21===s?parseScientific(r*(a+o/i),t,e+1,n):r*(a+o/i);o=10*o+s,i*=10,++e}return r*(a+o/i)}if(53===s||21===s)return parseScientific(r*a,t,e+1,n);break}a=10*a+s,++e}return r*a}var v=(w.prototype.getString=function(t){return""+this.data[t]},w.prototype.getInteger=function(t){return 0|this.data[t]},w.prototype.getFloat=function(t){return 1*this.data[t]},w.prototype.stringEquals=function(t,e){return this.data[t]===y(e,0,e.length)},w.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},w.prototype.getValuePresence=function(t){return 0},w);function w(t){this.data=t,this.isDefined=!0}var E=(x.prototype.getString=function(t){return 0===this.mask[t]?""+this.data[t]:null},x.prototype.getInteger=function(t){return 0===this.mask[t]?this.data[t]:0},x.prototype.getFloat=function(t){return 0===this.mask[t]?this.data[t]:0},x.prototype.stringEquals=function(t,e){return 0===this.mask[t]?this.data[t]===y(e,0,e.length):null==e},x.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},x.prototype.getValuePresence=function(t){return this.mask[t]},x);function x(t,e){this.data=t,this.mask=e,this.isDefined=!0}var C=(b.prototype.getString=function(t){return this.data[t]},b.prototype.getInteger=function(t){var e=this.data[t];return h(e,0,e.length)},b.prototype.getFloat=function(t){var e=this.data[t];return y(e,0,e.length)},b.prototype.stringEquals=function(t,e){return this.data[t]===e},b.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},b.prototype.getValuePresence=function(t){return 0},b);function b(t){this.data=t,this.isDefined=!0}var A=(I.prototype.getString=function(t){return 0===this.mask[t]?this.data[t]:null},I.prototype.getInteger=function(t){if(0!==this.mask[t])return 0;var e=this.data[t];return h(e||"",0,(e||"").length)},I.prototype.getFloat=function(t){if(0!==this.mask[t])return 0;var e=this.data[t];return y(e||"",0,(e||"").length)},I.prototype.stringEquals=function(t,e){return this.data[t]===e},I.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},I.prototype.getValuePresence=function(t){return this.mask[t]},I);function I(t,e){this.data=t,this.mask=e,this.isDefined=!0}function D(t){this.dataBlocks=t.dataBlocks.map(function(t){return new r(t)})}return new(D.prototype.toJSON=function(){return this.dataBlocks.map(function(t){return t.toJSON()})},D)(n)},iCn3DUI.prototype.MessagePackParse=function(t){var a=this;function e(t,e){for(var n={},r=0;r<e;r++){n[a.MessagePackParse(t)]=a.MessagePackParse(t)}return n}function n(t,e){for(var n=new Uint8Array(e),r=t.offset,a=0;a<e;a++)n[a]=t.buffer[a+r];return t.offset+=e,n}function r(t,e){for(var n=new Array(e),r=0;r<e;r++)n[r]=a.MessagePackParse(t);return n}function o(t,e){var n=function(t,e,n){for(var r=c,a=void 0,o=[],i=0,s=e,u=e+n;s<u;s++){var f=t[s];0==(128&f)?o[i++]=r[f]:192==(224&f)?o[i++]=r[(15&f)<<6|63&t[++s]]:224==(240&f)?o[i++]=String.fromCharCode((15&f)<<12|(63&t[++s])<<6|(63&t[++s])<<0):240==(248&f)?o[i++]=String.fromCharCode((7&f)<<18|(63&t[++s])<<12|(63&t[++s])<<6|(63&t[++s])<<0):throwError("Invalid byte "+f.toString(16)),512===i&&((a=a||[])[a.length]=o.join(""),i=0)}if(!a)return o.slice(0,i).join("");0<i&&(a[a.length]=o.slice(0,i).join(""));return a.join("")}(t.buffer,t.offset,e);return t.offset+=e,n}var c=function(){for(var t=[],e=0;e<1024;e++)t[e]=String.fromCharCode(e);return t}();var i,s,u=t.buffer[t.offset];if(0==(128&u))return t.offset++,u;if(128==(240&u))return s=15&u,t.offset++,e(t,s);if(144==(240&u))return s=15&u,t.offset++,r(t,s);if(160==(224&u))return s=31&u,t.offset++,o(t,s);if(224==(224&u))return i=t.dataView.getInt8(t.offset),t.offset++,i;switch(u){case 192:return t.offset++,null;case 194:return t.offset++,!1;case 195:return t.offset++,!0;case 196:return s=t.dataView.getUint8(t.offset+1),t.offset+=2,n(t,s);case 197:return s=t.dataView.getUint16(t.offset+1),t.offset+=3,n(t,s);case 198:return s=t.dataView.getUint32(t.offset+1),t.offset+=5,n(t,s);case 202:return i=t.dataView.getFloat32(t.offset+1),t.offset+=5,i;case 203:return i=t.dataView.getFloat64(t.offset+1),t.offset+=9,i;case 204:return i=t.buffer[t.offset+1],t.offset+=2,i;case 205:return i=t.dataView.getUint16(t.offset+1),t.offset+=3,i;case 206:return i=t.dataView.getUint32(t.offset+1),t.offset+=5,i;case 208:return i=t.dataView.getInt8(t.offset+1),t.offset+=2,i;case 209:return i=t.dataView.getInt16(t.offset+1),t.offset+=3,i;case 210:return i=t.dataView.getInt32(t.offset+1),t.offset+=5,i;case 217:return s=t.dataView.getUint8(t.offset+1),t.offset+=2,o(t,s);case 218:return s=t.dataView.getUint16(t.offset+1),t.offset+=3,o(t,s);case 219:return s=t.dataView.getUint32(t.offset+1),t.offset+=5,o(t,s);case 220:return s=t.dataView.getUint16(t.offset+1),t.offset+=3,r(t,s);case 221:return s=t.dataView.getUint32(t.offset+1),t.offset+=5,r(t,s);case 222:return s=t.dataView.getUint16(t.offset+1),t.offset+=3,e(t,s);case 223:return s=t.dataView.getUint32(t.offset+1),t.offset+=5,e(t,s)}};