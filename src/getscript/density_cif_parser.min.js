iCn3DUI.prototype.DensityCifParser=function(t,e,n,r){var a,o=this,i=o.icn3d,s=o.isMobile()||o.cfg.notebook?0:4;if("2fofc"==e||"fofc"==e?a="https://www.ebi.ac.uk/pdbe/densities/x-ray/"+t.toLowerCase()+"/cell?detail="+s:"em"==e&&(a="https://www.ebi.ac.uk/pdbe/densities/emd/"+r.toLowerCase()+"/cell?detail="+s),"2fofc"==e&&o.bAjax2fofc)i.mapData.sigma2=n,o.setOption("map",e);else if("fofc"==e&&o.bAjaxfofc)i.mapData.sigma=n,o.setOption("map",e);else if("em"==e&&o.bAjaxEm)i.mapData.sigmaEm=n,o.setOption("emmap",e);else{var u=new XMLHttpRequest;u.open("GET",a,!0),u.responseType="arraybuffer",u.onreadystatechange=function(){if(4==this.readyState){if(200==this.status){var t=u.response;o.parseChannels(t,e,n),"2fofc"==e||"fofc"==e?(o.bAjax2fofc=!0,o.bAjaxfofc=!0,o.setOption("map",e)):"em"==e&&(o.bAjaxEm=!0,o.setOption("emmap",e))}else"2fofc"==e||"fofc"==e?alert("Density server at EBI has no corresponding electron density map for this structure."):"em"==e&&alert("Density server at EBI has no corresponding EM density map for this structure.");void 0!==o.deferredEmmap&&o.deferredEmmap.resolve()}else o.showLoading()},u.send()}},iCn3DUI.prototype.parseChannels=function(t,e,n){var r=this,a=r.icn3d,o=r.BinaryParse(t);if("2fofc"==e||"fofc"==e){var i=r.getChannel(o,"2FO-FC"),s=r.getChannel(o,"FO-FC"),u={xExtent:(h=(d=i).box.sampleCount)[0],yExtent:h[1],zExtent:h[2],mean:d.valuesInfo.mean,sigma:d.valuesInfo.sigma};a.mapData.header2=u,a.mapData.data2=d.data;var f=d.box.origin,c=d.box.dimensions,l=d.spacegroup.basis,p=(new THREE.Matrix4).makeScale(c[0]/h[0],c[1]/h[1],c[2]/h[2]),g=(new THREE.Matrix4).makeTranslation(f[0],f[1],f[2]),m=(new THREE.Matrix4).set(l.x[0],l.y[0],l.z[0],0,0,l.y[1],l.z[1],0,0,0,l.z[2],0,0,0,0,1).multiply(g).multiply(p);a.mapData.matrix2=m,a.mapData.type2=e,a.mapData.sigma2=n,u={xExtent:(h=(d=s).box.sampleCount)[0],yExtent:h[1],zExtent:h[2],mean:d.valuesInfo.mean,sigma:d.valuesInfo.sigma},a.mapData.header=u,a.mapData.data=d.data,f=d.box.origin,c=d.box.dimensions,l=d.spacegroup.basis,p=(new THREE.Matrix4).makeScale(c[0]/h[0],c[1]/h[1],c[2]/h[2]),g=(new THREE.Matrix4).makeTranslation(f[0],f[1],f[2]),m=(new THREE.Matrix4).set(l.x[0],l.y[0],l.z[0],0,0,l.y[1],l.z[1],0,0,0,l.z[2],0,0,0,0,1).multiply(g).multiply(p),a.mapData.matrix=m,a.mapData.type=e,a.mapData.sigma=n}else if("em"==e){var d,h;u={xExtent:(h=(d=r.getChannel(o,"EM")).box.sampleCount)[0],yExtent:h[1],zExtent:h[2],max:d.valuesInfo.max,min:d.valuesInfo.min};a.mapData.headerEm=u,a.mapData.dataEm=d.data;f=d.box.origin,c=d.box.dimensions,l=d.spacegroup.basis,p=(new THREE.Matrix4).makeScale(c[0]/h[0],c[1]/h[1],c[2]/h[2]),g=(new THREE.Matrix4).makeTranslation(f[0],f[1],f[2]),m=(new THREE.Matrix4).set(l.x[0],l.y[0],l.z[0],0,0,l.y[1],l.z[1],0,0,0,l.z[2],0,0,0,0,1).multiply(g).multiply(p);a.mapData.matrixEm=m,a.mapData.typeEm=e,a.mapData.sigmaEm=n}},iCn3DUI.prototype.getChannel=function(t,e){this.icn3d;for(var n,r=t.toJSON(),a=0,o=r.length;a<o;++a)r[a].id==e&&(n=t.dataBlocks[a]);return this.CIFParse(n)},iCn3DUI.prototype.CIFParse=function(t){this.icn3d;var e=t.getCategory("_volume_data_3d_info");if(e){if(t.getCategory("_volume_data_3d")){var n={name:e.getColumn("name").getString(0),axisOrder:w("axis_order"),origin:w("origin"),dimensions:w("dimensions"),sampleCount:w("sample_count"),spacegroupNumber:0|v("spacegroup_number"),cellSize:w("spacegroup_cell_size"),cellAngles:w("spacegroup_cell_angles"),mean:v("mean_sampled"),sigma:v("sigma_sampled")},r=[0,0,0];r[n.axisOrder[0]]=0,r[n.axisOrder[1]]=1,r[n.axisOrder[2]]=2;var a,o,i,s,u,f,c,l,p,g,m,d,h=E(n.sampleCount),y=function(t,e,n,r){for(var a=new Float32Array(e[0]*e[1]*e[2]),o=[0,0,0],i=r[0],s=r[1],u=r[2],f=n[0],c=n[1],l=n[2],p=(e[0],e[0],e[1],e[2]),g=e[1]*e[2],m=0,d=t.getFloat(0),h=d,y=0;y<l;y++){o[2]=y;for(var w=0;w<c;w++){o[1]=w;for(var v=0;v<f;v++){o[0]=v;var E=t.getFloat(m);m+=1,a[o[u]+o[s]*p+o[i]*g]=E,E<d?d=E:E>h&&(h=E)}}}return{data:a,min:d,max:h}}(t.getCategory("_volume_data_3d").getColumn("values"),h,n.sampleCount,r);return{name:n.name,spacegroup:(a=n.spacegroupNumber,o=n.cellSize,i=n.cellAngles,s=Math.PI/180*i[0],u=Math.PI/180*i[1],f=Math.PI/180*i[2],c=o[0],l=o[1],p=o[2],g=Math.cos(u),m=(Math.cos(s)-Math.cos(u)*Math.cos(f))/Math.sin(f),d=Math.sqrt(1-g*g-m*m),{number:a,size:o,angles:i,basis:{x:[c,0,0],y:[Math.cos(f)*l,Math.sin(f)*l,0],z:[g*p,m*p,d*p]}}),box:{origin:E(n.origin),dimensions:E(n.dimensions),sampleCount:h},data:y.data,valuesInfo:{min:y.min,max:y.max,mean:n.mean,sigma:n.sigma}}}conole.log("_volume_data_3d category is missing.")}else conole.log("_volume_data_3d_info category is missing.");function w(t){for(var n=[0,0,0],r=0;r<3;r++)n[r]=e.getColumn(t+"["+r+"]").getFloat(0);return n}function v(t){return e.getColumn(t).getFloat(0)}function E(t){return[t[r[0]],t[r[1]],t[r[2]]]}},iCn3DUI.prototype.BinaryParse=function(t){this.icn3d;var e=new Uint8Array(t),n=this.MessagePackParse({buffer:e,offset:0,dataView:new DataView(e.buffer)}),r=function(){function t(t){this.additionalData={},this.header=t.header,this.categoryList=t.categories.map(function(t){return new a(t)}),this.categoryMap=new Map;for(var e=0,n=this.categoryList;e<n.length;e++){var r=n[e];this.categoryMap.set(r.name,r)}}return Object.defineProperty(t.prototype,"categories",{get:function(){return this.categoryList},enumerable:!0,configurable:!0}),t.prototype.getCategory=function(t){return this.categoryMap.get(t)},t.prototype.toJSON=function(){return{id:this.header,categories:this.categoryList.map(function(t){return t.toJSON()}),additionalData:this.additionalData}},t}(),a=function(){function t(t){this.name=t.name,this.columnCount=t.columns.length,this.rowCount=t.rowCount,this.columnNameList=[],this.encodedColumns=new Map;for(var e=0,n=t.columns;e<n.length;e++){var r=n[e];this.encodedColumns.set(r.name,r),this.columnNameList.push(r.name)}}Object.defineProperty(t.prototype,"columnNames",{get:function(){return this.columnNameList},enumerable:!0,configurable:!0});var e=function(){function t(){this.isDefined=!1}return t.prototype.getString=function(t){return null},t.prototype.getInteger=function(t){return 0},t.prototype.getFloat=function(t){return 0},t.prototype.getValuePresence=function(t){return 1},t.prototype.areValuesEqual=function(t,e){return!0},t.prototype.stringEquals=function(t,e){return null===e},t}();return t.prototype.getColumn=function(t){var n=this.encodedColumns.get(t);return n?d(n):e},t.prototype.toJSON=function(){for(var t=this,e=[],n=this.columnNameList.map(function(e){return{name:e,column:t.getColumn(e)}}),r=0;r<this.rowCount;r++){for(var a={},o=0,i=n;o<i.length;o++){var s=i[o],u=s.column.getValuePresence(r);a[s.name]=0===u?s.column.getString(r):1===u?".":"?"}e[r]=a}return{name:this.name,columns:this.columnNames,rows:e}},t}();function o(t,e){switch(t){case 1:return new Int8Array(e);case 2:return new Int16Array(e);case 3:return new Int32Array(e);case 4:return new Uint8Array(e);case 5:return new Uint16Array(e);case 6:return new Uint32Array(e);default:throw new Error("Unsupported integer data type.")}}function i(t,e){switch(t){case 32:return new Float32Array(e);case 33:return new Float64Array(e);default:throw new Error("Unsupported floating data type.")}}var s,u,f,c=(s=new ArrayBuffer(2),u=new Uint8Array(s),f=new Uint16Array(s),u[0]=170,u[1]=187,48042===f[0]);function l(t,e,n){return new n(c?t.buffer:function(t,e){for(var n=new ArrayBuffer(t.length),r=new Uint8Array(n),a=0,o=t.length;a<o;a+=e)for(var i=0;i<e;i++)r[a+e-i-1]=t[a+i];return n}(t,e))}function p(t,e){return e.isUnsigned?function(t,e){for(var n=1===e.byteCount?255:65535,r=t.length,a=new Int32Array(e.srcSize),o=0,i=0;o<r;){for(var s=0,u=t[o];u===n;)s+=u,u=t[++o];s+=u,a[i]=s,o++,i++}return a}(t,e):function(t,e){for(var n=1===e.byteCount?127:32767,r=-n-1,a=t.length,o=new Int32Array(e.srcSize),i=0,s=0;i<a;){for(var u=0,f=t[i];f===n||f===r;)u+=f,f=t[++i];u+=f,o[s]=u,i++,s++}return o}(t,e)}function g(t,e){switch(e.kind){case"ByteArray":switch(e.type){case 4:return t;case 1:return function(t){return new Int8Array(t.buffer,t.byteOffset)}(t);case 2:return function(t){return l(t,2,Int16Array)}(t);case 5:return function(t){return l(t,2,Uint16Array)}(t);case 3:return function(t){return l(t,4,Int32Array)}(t);case 6:return function(t){return l(t,4,Uint32Array)}(t);case 32:return function(t){return l(t,4,Float32Array)}(t);case 33:return function(t){return l(t,8,Float64Array)}(t);default:throw new Error("Unsupported ByteArray type.")}case"FixedPoint":return function(t,e){for(var n=t.length,r=i(e.srcType,n),a=1/e.factor,o=0;o<n;o++)r[o]=a*t[o];return r}(t,e);case"IntervalQuantization":return function(t,e){for(var n=t.length,r=i(e.srcType,n),a=(e.max-e.min)/(e.numSteps-1),o=e.min,s=0;s<n;s++)r[s]=o+a*t[s];return r}(t,e);case"RunLength":return function(t,e){for(var n=o(e.srcType,e.srcSize),r=0,a=0,i=t.length;a<i;a+=2)for(var s=t[a],u=t[a+1],f=0;f<u;++f)n[r++]=s;return n}(t,e);case"Delta":return function(t,e){var n=t.length,r=o(e.srcType,n);if(!n)return r;r[0]=t[0]+(0|e.origin);for(var a=1;a<n;++a)r[a]=t[a]+r[a-1];return r}(t,e);case"IntegerPacking":return p(t,e);case"StringArray":return function(t,e){for(var n=e.stringData,r=m({encoding:e.offsetEncoding,data:e.offsets}),a=m({encoding:e.dataEncoding,data:t}),o=Object.create(null),i=new Array(a.length),s=0,u=0,f=a;u<f.length;u++){var c=f[u];if(c<0)i[s++]=null;else{var l=o[c];void 0===l&&(l=n.substring(r[c],r[c+1]),o[c]=l),i[s++]=l}}return i}(t,e)}}function m(t){for(var e=t.data,n=t.encoding.length-1;n>=0;n--)e=g(e,t.encoding[n]);return e}function d(t){if(!t.data.data)return _UndefinedColumn;var e=m(t.data),n=void 0;return t.mask&&(n=m(t.mask)),e.buffer&&e.byteLength&&e.BYTES_PER_ELEMENT?n?new v(e,n):new w(e):n?new x(e,n):new E(e)}function h(t,e,n){var r=0,a=1;for(45===t.charCodeAt(e)&&(a=-1,e++);e<n;e++){var o=t.charCodeAt(e)-48;if(o>9||o<0)return a*r|0;r=10*r+o|0}return a*r}function y(t,e,n){var r=1,a=0,o=0,i=1;for(45===t.charCodeAt(e)&&(r=-1,++e);e<n;){var s=t.charCodeAt(e)-48;if(!(s>=0&&s<10)){if(-2===s){for(++e;e<n;){if(!((s=t.charCodeAt(e)-48)>=0&&s<10))return 53===s||21===s?parseScientific(r*(a+o/i),t,e+1,n):r*(a+o/i);o=10*o+s,i*=10,++e}return r*(a+o/i)}if(53===s||21===s)return parseScientific(r*a,t,e+1,n);break}a=10*a+s,++e}return r*a}var w=function(){function t(t){this.data=t,this.isDefined=!0}return t.prototype.getString=function(t){return""+this.data[t]},t.prototype.getInteger=function(t){return 0|this.data[t]},t.prototype.getFloat=function(t){return 1*this.data[t]},t.prototype.stringEquals=function(t,e){return this.data[t]===y(e,0,e.length)},t.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},t.prototype.getValuePresence=function(t){return 0},t}(),v=function(){function t(t,e){this.data=t,this.mask=e,this.isDefined=!0}return t.prototype.getString=function(t){return 0===this.mask[t]?""+this.data[t]:null},t.prototype.getInteger=function(t){return 0===this.mask[t]?this.data[t]:0},t.prototype.getFloat=function(t){return 0===this.mask[t]?this.data[t]:0},t.prototype.stringEquals=function(t,e){return 0===this.mask[t]?this.data[t]===y(e,0,e.length):null===e||void 0===e},t.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},t.prototype.getValuePresence=function(t){return this.mask[t]},t}(),E=function(){function t(t){this.data=t,this.isDefined=!0}return t.prototype.getString=function(t){return this.data[t]},t.prototype.getInteger=function(t){var e=this.data[t];return h(e,0,e.length)},t.prototype.getFloat=function(t){var e=this.data[t];return y(e,0,e.length)},t.prototype.stringEquals=function(t,e){return this.data[t]===e},t.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},t.prototype.getValuePresence=function(t){return 0},t}(),x=function(){function t(t,e){this.data=t,this.mask=e,this.isDefined=!0}return t.prototype.getString=function(t){return 0===this.mask[t]?this.data[t]:null},t.prototype.getInteger=function(t){if(0!==this.mask[t])return 0;var e=this.data[t];return h(e||"",0,(e||"").length)},t.prototype.getFloat=function(t){if(0!==this.mask[t])return 0;var e=this.data[t];return y(e||"",0,(e||"").length)},t.prototype.stringEquals=function(t,e){return this.data[t]===e},t.prototype.areValuesEqual=function(t,e){return this.data[t]===this.data[e]},t.prototype.getValuePresence=function(t){return this.mask[t]},t}();return new(function(){function t(t){this.dataBlocks=t.dataBlocks.map(function(t){return new r(t)})}return t.prototype.toJSON=function(){return this.dataBlocks.map(function(t){return t.toJSON()})},t}())(n)},iCn3DUI.prototype.MessagePackParse=function(t){var e=this;e.icn3d;function n(t,n){for(var r={},a=0;a<n;a++){r[e.MessagePackParse(t)]=e.MessagePackParse(t)}return r}function r(t,e){for(var n=new Uint8Array(e),r=t.offset,a=0;a<e;a++)n[a]=t.buffer[a+r];return t.offset+=e,n}function a(t,n){for(var r=new Array(n),a=0;a<n;a++)r[a]=e.MessagePackParse(t);return r}function o(t,e){var n=function(t,e,n){for(var r=i,a=void 0,o=[],s=0,u=e,f=e+n;u<f;u++){var c=t[u];0==(128&c)?o[s++]=r[c]:192==(224&c)?o[s++]=r[(15&c)<<6|63&t[++u]]:224==(240&c)?o[s++]=String.fromCharCode((15&c)<<12|(63&t[++u])<<6|(63&t[++u])<<0):240==(248&c)?o[s++]=String.fromCharCode((7&c)<<18|(63&t[++u])<<12|(63&t[++u])<<6|(63&t[++u])<<0):throwError("Invalid byte "+c.toString(16)),512===s&&((a=a||[])[a.length]=o.join(""),s=0)}if(!a)return o.slice(0,s).join("");s>0&&(a[a.length]=o.slice(0,s).join(""));return a.join("")}(t.buffer,t.offset,e);return t.offset+=e,n}var i=function(){for(var t=[],e=0;e<1024;e++)t[e]=String.fromCharCode(e);return t}();var s,u,f=t.buffer[t.offset];if(0==(128&f))return t.offset++,f;if(128==(240&f))return u=15&f,t.offset++,n(t,u);if(144==(240&f))return u=15&f,t.offset++,a(t,u);if(160==(224&f))return u=31&f,t.offset++,o(t,u);if(224==(224&f))return s=t.dataView.getInt8(t.offset),t.offset++,s;switch(f){case 192:return t.offset++,null;case 194:return t.offset++,!1;case 195:return t.offset++,!0;case 196:return u=t.dataView.getUint8(t.offset+1),t.offset+=2,r(t,u);case 197:return u=t.dataView.getUint16(t.offset+1),t.offset+=3,r(t,u);case 198:return u=t.dataView.getUint32(t.offset+1),t.offset+=5,r(t,u);case 202:return s=t.dataView.getFloat32(t.offset+1),t.offset+=5,s;case 203:return s=t.dataView.getFloat64(t.offset+1),t.offset+=9,s;case 204:return s=t.buffer[t.offset+1],t.offset+=2,s;case 205:return s=t.dataView.getUint16(t.offset+1),t.offset+=3,s;case 206:return s=t.dataView.getUint32(t.offset+1),t.offset+=5,s;case 208:return s=t.dataView.getInt8(t.offset+1),t.offset+=2,s;case 209:return s=t.dataView.getInt16(t.offset+1),t.offset+=3,s;case 210:return s=t.dataView.getInt32(t.offset+1),t.offset+=5,s;case 217:return u=t.dataView.getUint8(t.offset+1),t.offset+=2,o(t,u);case 218:return u=t.dataView.getUint16(t.offset+1),t.offset+=3,o(t,u);case 219:return u=t.dataView.getUint32(t.offset+1),t.offset+=5,o(t,u);case 220:return u=t.dataView.getUint16(t.offset+1),t.offset+=3,a(t,u);case 221:return u=t.dataView.getUint32(t.offset+1),t.offset+=5,a(t,u);case 222:return u=t.dataView.getUint16(t.offset+1),t.offset+=3,n(t,u);case 223:return u=t.dataView.getUint32(t.offset+1),t.offset+=5,n(t,u)}};